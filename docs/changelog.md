# Changelog Generation

`ai-code-sessions` can automatically generate structured changelog entries after exporting a transcript. These aren't git commit messages—they're higher-level summaries of what an entire AI-assisted coding session accomplished.

## Why Changelogs?

When you work with an AI coding assistant, a lot happens in a single session:
- Multiple files get created, modified, or deleted
- Tests get written and run
- Bugs get fixed, features get added
- Sometimes you go down rabbit holes and back out

Changelog entries capture the *intent* and *outcome* of a session, not just the individual changes. They're useful for:

- **Context for future AI sessions**: "What did I accomplish yesterday?"
- **Team visibility**: "What has this AI assistant been doing in our codebase?"
- **Release notes**: Aggregate session changelogs into release summaries
- **Personal productivity tracking**: See patterns in your AI-assisted work

---

## What Gets Captured

Each changelog entry includes:

| Field | Description | Example |
|-------|-------------|---------|
| `schema_version` | Entry schema version | `1` |
| `run_id` | Content-based hash (prevents duplicates) | `"c2157e415f33ca4a"` |
| `created_at` | When the entry was created | `"2026-01-04T10:17:01.096900+00:00"` |
| `tool` | Session source | `"codex"` |
| `actor` | Changelog actor | `"russronchi"` |
| `project` | Repo name | `"ai-code-sessions"` |
| `project_root` | Repo root path | `"$HOME/.../ai-code-sessions"` |
| `label` | Session label | `"Code Review 1"` |
| `start` / `end` | Session window | `"2026-01-04T10:07:18.024479+00:00"` |
| `session_dir` | Output directory | `".../.codex/sessions/2026-01-04-0207_Code_Review_1"` |
| `continuation_of_run_id` | Prior run when resuming | `"b1a2..."` or `null` |
| `transcript` | Transcript paths | `{ "index_html": "...", "source_jsonl": "...", ... }` |
| `summary` | One-line description | `"Fixed authentication race condition"` |
| `bullets` | 3-12 specific accomplishments | `["Added mutex to token refresh", "Added retry logic", ...]` |
| `tags` | Classification | `["fix", "auth"]` |
| `touched_files` | Created/modified/deleted/moved | `{ "created": [...], "moved": [{"from":"...","to":"..."}] }` |
| `tests` | Test commands + results | `[{"cmd":"uv run pytest","result":"pass"}]` |
| `commits` | Git commits made | `[{"hash":"abc1234","message":"Fix auth race"}]` |
| `notes` | Optional extra notes | `null` |

---

## File Locations

### In Your Project Repo

```
.changelog/
└── your-username/
    ├── entries.jsonl    # Successful changelog entries (one JSON object per line)
    └── failures.jsonl   # Failed generation attempts (for debugging)
```

### In Each Session Directory

```
.codex/sessions/2026-01-02-1435_My_Session/
├── index.html
├── ...
└── export_runs.jsonl    # Tracks each export for delta-aware backfills
```

---

## Enabling Changelog Generation

> **Note:** Changelog entries are **delta-aware** only when `export_runs.jsonl` exists in the session directory. This file is created by `ais ctx` and tracks each export window, enabling backfill to generate separate entries for resumed sessions instead of one big entry per directory.

### Option 1: Environment Variables

Quick setup for your shell:

```bash
# Add to ~/.bashrc or ~/.zshrc
export CTX_ACTOR="your-github-username"
export CTX_CHANGELOG=1
```

### Option 2: Setup Wizard

Run the interactive wizard:

```bash
ais setup
```

It will ask about changelog generation and write the config for you.

### Option 3: Config File

Create `.ai-code-sessions.toml` in your project root:

```toml
[changelog]
enabled = true
actor = "your-github-username"
```

### Option 4: CLI Flag

Enable for a single export:

```bash
ais export-latest ... --changelog --changelog-actor "your-username"
```

---

## Choosing an Evaluator

Changelog entries are generated by running an AI model over a digest of your session. You can choose which model to use:

### Codex (Default)

By default, ai-code-sessions invokes Codex CLI with `gpt-5.2` and `model_reasoning_effort="xhigh"` (overrideable):

```bash
export CTX_CHANGELOG_EVALUATOR="codex"
```

Or in config:

```toml
[changelog]
evaluator = "codex"
model = ""  # Blank uses the ai-code-sessions default (gpt-5.2 + xhigh)
```

Codex CLI documents its model list (for example, `gpt-5.2-codex` and `gpt-5.1-codex-mini`) and accepts `--model`/`-m` overrides. See the [Codex CLI documentation](https://platform.openai.com/docs/guides/codex) for the current list of supported models.

### Claude

Uses Claude Code CLI with Opus and 8192 thinking tokens (default):

```bash
export CTX_CHANGELOG_EVALUATOR="claude"
export CTX_CHANGELOG_MODEL="opus"
export CTX_CHANGELOG_CLAUDE_THINKING_TOKENS="8192"
```

Or in config:

```toml
[changelog]
evaluator = "claude"
model = "opus"
claude_thinking_tokens = 8192
```

See the [Claude Code documentation](https://docs.anthropic.com/en/docs/claude-code) for the current list of supported models.

### Trade-offs

| Evaluator | Speed | Cost | Quality |
|-----------|-------|------|---------|
| Codex (default `gpt-5.2`) | Fast | Lower | Good summarization |
| Claude (default `opus`) | Slower | Higher | More detailed analysis |

---

## How It Works Under the Hood

1. **Digest Creation**: The session transcript is condensed into a "digest" that includes:
   - User prompts (full text)
   - Assistant text responses (truncated if long)
   - Tool calls (name + key parameters)
   - Tool outputs (only for errors—success output is omitted to save tokens)

2. **Evaluator Invocation**: The digest is passed to the evaluator (Codex or Claude) with a prompt asking for structured JSON output.

3. **Retry on Overflow**: If the context window overflows, the evaluator retries with a smaller "budget" digest that aggressively truncates content.

4. **Deduplication**: Each entry gets a content-based ID. If you re-run export on the same session, duplicate entries are detected and skipped.

5. **Append-Only**: Entries are appended to `entries.jsonl`, never overwritten. This creates a reliable audit trail.

---

## Backfilling Existing Sessions

If you have session directories from before you enabled changelogs, you can generate entries retroactively:

### Basic Backfill

```bash
# Backfill all sessions in current repo
ais changelog backfill --project-root "$(git rev-parse --show-toplevel)"
```

### Backfill a Specific Directory

```bash
ais changelog backfill --sessions-dir ./.codex/sessions
```

### Using Claude for Backfill

For higher-quality entries (at higher cost):

```bash
ais changelog backfill \
  --evaluator claude \
  --model opus \
  --max-concurrency 3
```

Claude backfill runs evaluations in parallel (default: 5 concurrent). Reduce concurrency if you hit rate limits:

```bash
ais changelog backfill --evaluator claude --max-concurrency 1
```

### Limiting Backfill Scope

For testing or gradual migration:

```bash
# Process only 5 sessions
ais changelog backfill --limit 5

# Single session at a time (useful with --limit)
ais changelog backfill --limit 5 --max-concurrency 1
```

### Delta-Aware Backfill

If `export_runs.jsonl` exists in a session directory (created by newer versions of `ais ctx`), backfill can generate **separate entries for each session run** instead of one big entry per directory.

This is useful for resumed sessions that span multiple work periods.

---

## Querying Entries

Use `ais changelog since` to query entries by date or git commit.

### Basic Queries

```bash
# Entries since a specific date
ais changelog since 2026-01-06

# Entries since yesterday
ais changelog since yesterday

# Entries from the last 3 days
ais changelog since "3 days ago"

# Entries since a git commit
ais changelog since HEAD~5
ais changelog since abc1234
```

### Output Formats

```bash
# One-line summaries (default)
ais changelog since yesterday

# Full JSON for scripting
ais changelog since yesterday --format json

# Markdown with bullets and tags
ais changelog since "last week" --format bullets

# Markdown table
ais changelog since yesterday --format table
```

### Filtering

```bash
# By tool
ais changelog since yesterday --tool codex
ais changelog since yesterday --tool claude

# By tag (can repeat for OR)
ais changelog since "2 days ago" --tag feat
ais changelog since "2 days ago" --tag feat --tag fix

# By actor
ais changelog since yesterday --actor myusername
```

### Example Output

```bash
$ ais changelog since yesterday
2026-01-07 [codex] Fix auth bug: Fixed authentication race condition by adding mutex lock
2026-01-07 [codex] Add tests: Added unit tests for checkout flow
2026-01-06 [claude] Refactor API: Restructured API handlers for better testability
```

---

## Handling Failures

Changelog generation is **best-effort**—if it fails, the export still succeeds. Check for failures in:

```bash
cat .changelog/your-username/failures.jsonl | jq .
```

### Common Failure Causes

| Error | Cause | Solution |
|-------|-------|----------|
| `usage_limit_reached` / `HTTP 429` | Rate limited | Wait, then retry |
| `context window overflow` | Session too large | Retries with smaller digest automatically |
| `codex: command not found` | CLI not installed | Install Codex CLI |
| `claude: command not found` | CLI not installed | Install Claude CLI |
| Network timeout | Connectivity issue | Retry later |

### Viewing Failure Details

```bash
# See the most recent failure
tail -1 .changelog/*/failures.jsonl | jq .

# See the error message
tail -1 .changelog/*/failures.jsonl | jq '.error'

# See stderr output (most actionable)
tail -1 .changelog/*/failures.jsonl | jq '.stderr_tail'
```

---

## Validating and Fixing Entries

Sometimes changelog entries may have quality issues like truncated content or Unicode garbage. Use `ais changelog lint` to identify and fix these problems.

### Scanning for Issues

```bash
# Scan all entries
ais changelog lint

# Scan entries for a specific actor
ais changelog lint --actor myusername

# Show verbose output (including valid entries)
ais changelog lint --verbose
```

### What Gets Flagged

| Issue | Description |
|-------|-------------|
| Truncated content | Text ending mid-word or mid-sentence |
| Unicode garbage | Unexpected characters (e.g., Devanagari from ANSI issues) |
| Short bullets | Bullets with fewer than 5 characters |
| Path-only bullets | Bullets that appear to be just file paths |

### Fixing Issues

The `--fix` flag re-evaluates problematic entries using the stored session data:

```bash
# Preview what would be fixed
ais changelog lint --fix --dry-run

# Fix using the default evaluator (codex)
ais changelog lint --fix

# Fix using Claude
ais changelog lint --fix --evaluator claude
```

**Notes:**

- A backup (`entries.jsonl.bak`) is created before modifying entries
- Only entries with source transcripts still available can be fixed
- If source files have been deleted, those entries cannot be re-evaluated

### Refreshing Metadata (No Evaluator)

Some fields like `touched_files`, `tests`, and `commits` are derived from the stored transcript JSONL. If metadata extraction improves in a newer `ais` version, you can recompute these fields for historical entries without spending evaluator usage:

```bash
# Preview changes
ais changelog refresh-metadata --dry-run

# Refresh a specific actor's entries
ais changelog refresh-metadata --actor myusername

# Force recompute for every entry (not just empty touched_files)
ais changelog refresh-metadata --all
```

This command:

- Does **not** call Codex or Claude (no evaluator tokens)
- Creates a backup (`entries.jsonl.bak`) before modifying entries
- Skips entries that don't have an on-disk transcript at `transcript.source_jsonl`

---

## Privacy Considerations

Changelog entries contain:
- Summaries of your prompts and AI responses
- File paths that were created/modified/deleted/moved
- Git commit hashes and short messages
- Test commands and pass/fail results

They do **not** contain:
- Full file contents
- Command output (except for error snippets)
- Secrets (unless they appeared in prompts/responses)

### Recommendation

Add `.changelog/` to your `.gitignore` for public repos:

```gitignore
.changelog/
```

For private repos or team visibility, you may want to commit changelogs.

---

## Example Entries

### A Bug Fix Session

```json
{
  "schema_version": 1,
  "run_id": "c2157e415f33ca4a",
  "created_at": "2026-01-04T10:17:01.096900+00:00",
  "tool": "codex",
  "actor": "russronchi",
  "project": "ai-code-sessions",
  "project_root": "$HOME/Projects/ai-code-sessions",
  "label": "Fix Checkout Race",
  "start": "2026-01-04T10:07:18.024479+00:00",
  "end": "2026-01-04T10:16:34.084243+00:00",
  "session_dir": "$HOME/Projects/ai-code-sessions/.codex/sessions/2026-01-04-0207_Fix_Checkout_Race",
  "continuation_of_run_id": null,
  "transcript": {
    "output_dir": "$HOME/Projects/ai-code-sessions/.codex/sessions/2026-01-04-0207_Fix_Checkout_Race",
    "index_html": "$HOME/Projects/ai-code-sessions/.codex/sessions/2026-01-04-0207_Fix_Checkout_Race/index.html",
    "source_jsonl": "$HOME/Projects/ai-code-sessions/.codex/sessions/2026-01-04-0207_Fix_Checkout_Race/rollout-2026-01-04T02-07-18-019b8879-bc8e-7282-b235-118cc5d9949b.jsonl",
    "source_match_json": "$HOME/Projects/ai-code-sessions/.codex/sessions/2026-01-04-0207_Fix_Checkout_Race/source_match.json"
  },
  "summary": "Fixed race condition in checkout flow causing duplicate orders",
  "bullets": [
    "Added mutex lock around order creation",
    "Implemented idempotency key validation",
    "Added integration test for concurrent checkout",
    "Fixed flaky test in CartServiceTest"
  ],
  "tags": ["fix", "checkout", "concurrency"],
  "touched_files": {
    "created": ["src/checkout/mutex.ts", "tests/checkout/concurrent.test.ts"],
    "modified": ["src/checkout/order.ts", "src/checkout/cart.ts"],
    "deleted": [],
    "moved": []
  },
  "tests": [{"cmd": "uv run pytest", "result": "pass"}],
  "commits": [{"hash": "abc1234", "message": "Fix checkout race condition"}],
  "notes": null
}
```

---

## Tips

### Use Descriptive Session Labels

The session label influences the changelog summary. Good labels → good changelogs:

```bash
# Good
ais ctx "Fix checkout race condition causing duplicate orders" --codex

# Less good
ais ctx "fix bug" --codex
```

### Review Before Committing

If you decide to commit changelogs, review them first:

```bash
# See recent entries
tail -5 .changelog/*/entries.jsonl | jq .summary
```

### Aggregate for Release Notes

Use `jq` to extract and aggregate:

```bash
# All summaries from the past week
cat .changelog/*/entries.jsonl | \
  jq -r 'select(.created_at > "2026-01-01") | .summary'

# Group by tag
cat .changelog/*/entries.jsonl | \
  jq -r '.tags[]' | sort | uniq -c | sort -rn
```
