# Changelog Generation

`ai-code-sessions` can automatically generate structured changelog entries after exporting a transcript. These aren't git commit messages—they're higher-level summaries of what an entire AI-assisted coding session accomplished.

## Why Changelogs?

When you work with an AI coding assistant, a lot happens in a single session:
- Multiple files get created, modified, or deleted
- Tests get written and run
- Bugs get fixed, features get added
- Sometimes you go down rabbit holes and back out

Changelog entries capture the *intent* and *outcome* of a session, not just the individual changes. They're useful for:

- **Context for future AI sessions**: "What did I accomplish yesterday?"
- **Team visibility**: "What has this AI assistant been doing in our codebase?"
- **Release notes**: Aggregate session changelogs into release summaries
- **Personal productivity tracking**: See patterns in your AI-assisted work

---

## What Gets Captured

Each changelog entry includes:

| Field | Description | Example |
|-------|-------------|---------|
| `id` | Content-based hash (prevents duplicates) | `"abc123..."` |
| `created_at` | When the session started | `"2026-01-02T14:35:00Z"` |
| `summary` | One-line description | `"Fixed authentication race condition"` |
| `bullets` | 3-5 specific accomplishments | `["Added mutex to token refresh", "Added retry logic", ...]` |
| `tags` | Classification | `["fix", "auth"]` |
| `files_created` | New files | `["src/auth/mutex.ts"]` |
| `files_modified` | Changed files | `["src/auth/token.ts"]` |
| `files_deleted` | Removed files | `["src/auth/legacy.ts"]` |
| `test_passed` | Test outcome | `true` / `false` / `null` |
| `commits` | Git commits made | `["abc1234", "def5678"]` |
| `transcript_path` | Link to full transcript | `".codex/sessions/2026-01-02.../index.html"` |

---

## File Locations

### In Your Project Repo

```
.changelog/
└── your-username/
    ├── entries.jsonl    # Successful changelog entries (one JSON object per line)
    └── failures.jsonl   # Failed generation attempts (for debugging)
```

### In Each Session Directory

```
.codex/sessions/2026-01-02-1435_My_Session/
├── index.html
├── ...
└── export_runs.jsonl    # Tracks each export for delta-aware backfills
```

---

## Enabling Changelog Generation

### Option 1: Environment Variables

Quick setup for your shell:

```bash
# Add to ~/.bashrc or ~/.zshrc
export CTX_ACTOR="your-github-username"
export CTX_CHANGELOG=1
```

### Option 2: Setup Wizard

Run the interactive wizard:

```bash
ais setup
```

It will ask about changelog generation and write the config for you.

### Option 3: Config File

Create `.ai-code-sessions.toml` in your project root:

```toml
[changelog]
enabled = true
actor = "your-github-username"
```

### Option 4: CLI Flag

Enable for a single export:

```bash
ais export-latest ... --changelog --changelog-actor "your-username"
```

---

## Choosing an Evaluator

Changelog entries are generated by running an AI model over a digest of your session. You can choose which model to use:

### Codex (Default)

Uses the Codex CLI with GPT-5.2 and `xhigh` reasoning:

```bash
export CTX_CHANGELOG_EVALUATOR="codex"
```

Or in config:

```toml
[changelog]
evaluator = "codex"
model = ""  # Blank uses the default (gpt-5.2 + xhigh)
```

### Claude

Uses Claude Code CLI with Opus and max thinking:

```bash
export CTX_CHANGELOG_EVALUATOR="claude"
export CTX_CHANGELOG_MODEL="opus"
export CTX_CHANGELOG_CLAUDE_THINKING_TOKENS="8192"
```

Or in config:

```toml
[changelog]
evaluator = "claude"
model = "opus"
claude_thinking_tokens = 8192
```

### Trade-offs

| Evaluator | Speed | Cost | Quality |
|-----------|-------|------|---------|
| Codex (GPT-5.2) | Fast | Lower | Good summarization |
| Claude (Opus) | Slower | Higher | More detailed analysis |

---

## How It Works Under the Hood

1. **Digest Creation**: The session transcript is condensed into a "digest" that includes:
   - User prompts (full text)
   - Assistant text responses (truncated if long)
   - Tool calls (name + key parameters)
   - Tool outputs (only for errors—success output is omitted to save tokens)

2. **Evaluator Invocation**: The digest is passed to the evaluator (Codex or Claude) with a prompt asking for structured JSON output.

3. **Retry on Overflow**: If the context window overflows, the evaluator retries with a smaller "budget" digest that aggressively truncates content.

4. **Deduplication**: Each entry gets a content-based ID. If you re-run export on the same session, duplicate entries are detected and skipped.

5. **Append-Only**: Entries are appended to `entries.jsonl`, never overwritten. This creates a reliable audit trail.

---

## Backfilling Existing Sessions

If you have session directories from before you enabled changelogs, you can generate entries retroactively:

### Basic Backfill

```bash
# Backfill all sessions in current repo
ais changelog backfill --project-root "$(git rev-parse --show-toplevel)"
```

### Backfill a Specific Directory

```bash
ais changelog backfill --sessions-dir ./.codex/sessions
```

### Using Claude for Backfill

For higher-quality entries (at higher cost):

```bash
ais changelog backfill \
  --evaluator claude \
  --model opus \
  --max-concurrency 3
```

Claude backfill runs evaluations in parallel (default: 5 concurrent). Reduce concurrency if you hit rate limits:

```bash
ais changelog backfill --evaluator claude --max-concurrency 1
```

### Limiting Backfill Scope

For testing or gradual migration:

```bash
# Process only 5 sessions
ais changelog backfill --limit 5

# Single session at a time (useful with --limit)
ais changelog backfill --limit 5 --max-concurrency 1
```

### Delta-Aware Backfill

If `export_runs.jsonl` exists in a session directory (created by newer versions of `ais ctx`), backfill can generate **separate entries for each session run** instead of one big entry per directory.

This is useful for resumed sessions that span multiple work periods.

---

## Handling Failures

Changelog generation is **best-effort**—if it fails, the export still succeeds. Check for failures in:

```bash
cat .changelog/your-username/failures.jsonl | jq .
```

### Common Failure Causes

| Error | Cause | Solution |
|-------|-------|----------|
| `usage_limit_reached` / `HTTP 429` | Rate limited | Wait, then retry |
| `context window overflow` | Session too large | Retries with smaller digest automatically |
| `codex: command not found` | CLI not installed | Install Codex CLI |
| `claude: command not found` | CLI not installed | Install Claude CLI |
| Network timeout | Connectivity issue | Retry later |

### Viewing Failure Details

```bash
# See the most recent failure
tail -1 .changelog/*/failures.jsonl | jq .

# See the error message
tail -1 .changelog/*/failures.jsonl | jq '.error'

# See stderr output (most actionable)
tail -1 .changelog/*/failures.jsonl | jq '.stderr_tail'
```

---

## Privacy Considerations

Changelog entries contain:
- Summaries of your prompts and AI responses
- File paths that were created/modified/deleted
- Git commit hashes

They do **not** contain:
- Full file contents
- Command output (except for error snippets)
- Secrets (unless they appeared in prompts/responses)

### Recommendation

Add `.changelog/` to your `.gitignore` for public repos:

```gitignore
.changelog/
```

For private repos or team visibility, you may want to commit changelogs.

---

## Example Entries

### A Bug Fix Session

```json
{
  "id": "abc123def456...",
  "created_at": "2026-01-02T14:35:00Z",
  "summary": "Fixed race condition in checkout flow causing duplicate orders",
  "bullets": [
    "Added mutex lock around order creation",
    "Implemented idempotency key validation",
    "Added integration test for concurrent checkout",
    "Fixed flaky test in CartServiceTest"
  ],
  "tags": ["fix", "checkout", "concurrency"],
  "files_created": ["src/checkout/mutex.ts", "tests/checkout/concurrent.test.ts"],
  "files_modified": ["src/checkout/order.ts", "src/checkout/cart.ts"],
  "files_deleted": [],
  "test_passed": true,
  "commits": ["abc1234", "def5678"],
  "transcript_path": ".codex/sessions/2026-01-02-1435_Fix_Checkout_Race/index.html"
}
```

### A Feature Session

```json
{
  "id": "789ghi012jkl...",
  "created_at": "2026-01-03T09:00:00Z",
  "summary": "Added OAuth 2.0 support for Google and GitHub providers",
  "bullets": [
    "Implemented OAuth flow abstraction",
    "Added Google OAuth provider",
    "Added GitHub OAuth provider",
    "Created provider configuration UI",
    "Added E2E tests for OAuth flows"
  ],
  "tags": ["feat", "auth", "oauth"],
  "files_created": [
    "src/auth/oauth/base.ts",
    "src/auth/oauth/google.ts",
    "src/auth/oauth/github.ts"
  ],
  "files_modified": ["src/auth/index.ts", "src/config/providers.ts"],
  "files_deleted": ["src/auth/legacy-google.ts"],
  "test_passed": true,
  "commits": ["111aaa", "222bbb", "333ccc"],
  "transcript_path": ".codex/sessions/2026-01-03-0900_Add_OAuth/index.html"
}
```

---

## Tips

### Use Descriptive Session Labels

The session label influences the changelog summary. Good labels → good changelogs:

```bash
# Good
ais ctx "Fix checkout race condition causing duplicate orders" --codex

# Less good
ais ctx "fix bug" --codex
```

### Review Before Committing

If you decide to commit changelogs, review them first:

```bash
# See recent entries
tail -5 .changelog/*/entries.jsonl | jq .summary
```

### Aggregate for Release Notes

Use `jq` to extract and aggregate:

```bash
# All summaries from the past week
cat .changelog/*/entries.jsonl | \
  jq -r 'select(.created_at > "2026-01-01") | .summary'

# Group by tag
cat .changelog/*/entries.jsonl | \
  jq -r '.tags[]' | sort | uniq -c | sort -rn
```
